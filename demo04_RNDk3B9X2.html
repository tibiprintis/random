<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Alien Nebula Shooter</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, #1b2735, #090a0f 70%);
      color: #f5f5f5;
    }
    canvas {
      display: block;
    }
    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(2, 6, 16, 0.78);
      backdrop-filter: blur(6px);
      gap: 1.5rem;
      text-align: center;
      z-index: 10;
      padding: 2rem;
    }
    #overlay h1 {
      margin: 0;
      font-size: clamp(2rem, 4vw, 3rem);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    #overlay p {
      margin: 0;
      max-width: 40rem;
      line-height: 1.5;
      opacity: 0.8;
    }
    #overlay button {
      padding: 0.85rem 2.6rem;
      font-size: 1rem;
      border-radius: 999px;
      border: none;
      color: #0a0c15;
      background: linear-gradient(135deg, #8affef, #5ac8ff);
      cursor: pointer;
      box-shadow: 0 0.8rem 2rem rgba(90, 200, 255, 0.45);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #overlay button:hover {
      transform: translateY(-2px);
      box-shadow: 0 1.2rem 2.4rem rgba(90, 200, 255, 0.55);
    }
    #hud {
      position: absolute;
      inset: 0;
      pointer-events: none;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      font-size: 0.95rem;
      z-index: 5;
      mix-blend-mode: screen;
      text-shadow: 0 0 10px rgba(0, 180, 255, 0.5);
    }
    #hud .panel {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      pointer-events: auto;
    }
    #hud label {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.85rem;
      background: rgba(5, 19, 39, 0.65);
      padding: 0.5rem 0.8rem;
      border-radius: 10px;
      box-shadow: inset 0 0 0 1px rgba(40, 140, 255, 0.4);
    }
    #hud input[type="range"] {
      width: 12rem;
      accent-color: #7ee3ff;
    }
    #crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 18px;
      height: 18px;
      margin-left: -9px;
      margin-top: -9px;
      border: 2px solid rgba(126, 227, 255, 0.8);
      border-radius: 50%;
      box-shadow: 0 0 12px rgba(126, 227, 255, 0.65);
      transform: scale(0.9);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      z-index: 3;
    }
    #eventLog {
      background: rgba(7, 14, 26, 0.75);
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      max-height: 8rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      width: 12rem;
      font-size: 0.75rem;
      box-shadow: inset 0 0 0 1px rgba(50, 160, 255, 0.35);
    }
    #eventLog span {
      opacity: 0.7;
    }
    #statusBadges {
      display: flex;
      gap: 0.5rem;
    }
    .badge {
      background: rgba(120, 255, 199, 0.15);
      border: 1px solid rgba(120, 255, 199, 0.45);
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    footer {
      position: absolute;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.75rem;
      opacity: 0.35;
      pointer-events: none;
      text-transform: uppercase;
      letter-spacing: 0.2em;
    }
  </style>
</head>
<body>
  <div id="overlay">
    <h1>Alien Nebula Shooter</h1>
    <p>
      Defend your starship in a 3D nebula arena. Use <strong>WASD</strong> to drift, the
      <strong>mouse</strong> to aim, and <strong>click</strong> to fire plasma bolts. Adjust the polygon
      complexity of the alien crafts with the slider for performance tuning.
    </p>
    <button id="startButton">Enter the Nebula</button>
  </div>
  <div id="hud">
    <div class="panel">
      <div id="statusBadges">
        <span class="badge" id="badgeWave">Wave 1</span>
        <span class="badge" id="badgeStreak">Streak 0</span>
      </div>
      <label>
        Alien Geometry Detail
        <input id="detailSlider" type="range" min="6" max="48" value="18" step="2" />
      </label>
      <div id="eventLog"></div>
    </div>
    <div class="panel" style="align-items:flex-end;text-align:right;">
      <div class="badge" id="score">Score 0</div>
      <div class="badge" id="health">Shields 100%</div>
    </div>
  </div>
  <div id="crosshair"></div>
  <footer>Hold shift to boost thrusters â€¢ Plasma bolts recharge every 180ms</footer>
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.158.0/build/three.module.js';
    import { PointerLockControls } from 'https://unpkg.com/three@0.158.0/examples/jsm/controls/PointerLockControls.js';

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2('#04060f', 0.03);
    scene.background = new THREE.Color('#05060e');

    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 2, 5);

    const controls = new PointerLockControls(camera, document.body);
    const playerVelocity = new THREE.Vector3();
    const playerDirection = new THREE.Vector3();

    const hemiLight = new THREE.HemisphereLight('#78f8ff', '#090b14', 0.65);
    scene.add(hemiLight);

    const keyLight = new THREE.DirectionalLight('#9fd6ff', 1.1);
    keyLight.position.set(5, 7, 4);
    keyLight.castShadow = true;
    keyLight.shadow.mapSize.set(1024, 1024);
    scene.add(keyLight);

    const bounceLight = new THREE.PointLight('#7cf0d5', 1.3, 40, 2);
    bounceLight.position.set(-6, 1.5, -4);
    scene.add(bounceLight);

    const floorGeo = new THREE.PlaneGeometry(200, 200, 1, 1);
    const floorMat = new THREE.MeshStandardMaterial({
      color: '#101422',
      roughness: 0.8,
      metalness: 0.2,
      emissive: '#091025',
      emissiveIntensity: 0.35
    });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    const starGeo = new THREE.BufferGeometry();
    const starCount = 4000;
    const starPositions = new Float32Array(starCount * 3);
    for (let i = 0; i < starCount; i++) {
      const theta = Math.random() * Math.PI * 2;
      const phi = Math.acos(THREE.MathUtils.randFloatSpread(2));
      const radius = 120 + Math.random() * 80;
      starPositions[i * 3] = Math.sin(phi) * Math.cos(theta) * radius;
      starPositions[i * 3 + 1] = Math.cos(phi) * radius;
      starPositions[i * 3 + 2] = Math.sin(phi) * Math.sin(theta) * radius;
    }
    starGeo.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
    const starMat = new THREE.PointsMaterial({ color: '#7ff0ff', size: 0.75, transparent: true, opacity: 0.8 });
    const stars = new THREE.Points(starGeo, starMat);
    scene.add(stars);

    const nebulaUniforms = {
      time: { value: 0 },
      colorA: { value: new THREE.Color('#111741') },
      colorB: { value: new THREE.Color('#41f5ff') }
    };

    const nebulaMat = new THREE.ShaderMaterial({
      uniforms: nebulaUniforms,
      transparent: true,
      depthWrite: false,
      blending: THREE.AdditiveBlending,
      vertexShader: `
        varying vec2 vUv;
        void main() {
          vUv = uv;
          vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
          gl_Position = projectionMatrix * mvPosition;
        }
      `,
      fragmentShader: `
        varying vec2 vUv;
        uniform float time;
        uniform vec3 colorA;
        uniform vec3 colorB;
        void main() {
          float strength = pow(vUv.y, 1.5);
          float swirl = sin(vUv.x * 10.0 + time * 0.4) * 0.5 + 0.5;
          float glow = smoothstep(0.2, 0.9, swirl);
          vec3 color = mix(colorA, colorB, glow * strength);
          float alpha = smoothstep(0.0, 1.0, glow) * 0.35;
          gl_FragColor = vec4(color, alpha);
        }
      `
    });

    const nebulaGeo = new THREE.PlaneGeometry(150, 150, 1, 1);
    for (let i = 0; i < 8; i++) {
      const nebula = new THREE.Mesh(nebulaGeo, nebulaMat.clone());
      nebula.position.set(THREE.MathUtils.randFloatSpread(120), 20 + Math.random() * 15, THREE.MathUtils.randFloatSpread(120));
      nebula.rotation.x = -Math.PI / 2;
      nebula.rotation.z = Math.random() * Math.PI * 2;
      scene.add(nebula);
    }

    const ui = {
      overlay: document.getElementById('overlay'),
      startButton: document.getElementById('startButton'),
      crosshair: document.getElementById('crosshair'),
      detailSlider: document.getElementById('detailSlider'),
      score: document.getElementById('score'),
      health: document.getElementById('health'),
      badgeWave: document.getElementById('badgeWave'),
      badgeStreak: document.getElementById('badgeStreak'),
      eventLog: document.getElementById('eventLog')
    };

    let alienDetail = Number(ui.detailSlider.value);
    ui.detailSlider.addEventListener('input', () => {
      alienDetail = Number(ui.detailSlider.value);
      addLog(`Detail set to ${alienDetail}`);
    });

    const clock = new THREE.Clock();
    const bullets = [];
    const aliens = [];
    const particleBursts = [];
    const tmpVec3 = new THREE.Vector3();
    const player = new THREE.Object3D();
    scene.add(player);

    const muzzleFlash = new THREE.PointLight('#7af0ff', 0, 10, 2);
    scene.add(muzzleFlash);

    const playerShip = new THREE.Mesh(
      new THREE.ConeGeometry(0.5, 1.8, 12, 1, true),
      new THREE.MeshStandardMaterial({
        color: '#66d9ff',
        transparent: true,
        opacity: 0.35,
        emissive: '#66d9ff',
        emissiveIntensity: 0.8,
        wireframe: true
      })
    );
    playerShip.rotation.x = Math.PI / 2;
    playerShip.position.z = -1.2;
    player.add(playerShip);

    const controlsObject = controls.getObject();
    player.add(controlsObject);

    let score = 0;
    let streak = 0;
    let wave = 1;
    let shields = 100;
    let spawnTimer = 0;
    let nextSpawn = 3;
    let shootCooldown = 0;
    let isStarted = false;

    const audio = new (window.AudioContext || window.webkitAudioContext)();
    audio.suspend();

    function playSound(frequency, duration, type = 'sine', gain = 0.2) {
      const oscillator = audio.createOscillator();
      const gainNode = audio.createGain();
      oscillator.type = type;
      oscillator.frequency.value = frequency;
      gainNode.gain.value = gain;
      oscillator.connect(gainNode).connect(audio.destination);
      oscillator.start();
      gainNode.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + duration);
      oscillator.stop(audio.currentTime + duration);
    }

    function playShootSound() {
      playSound(680, 0.15, 'sawtooth', 0.08);
      playSound(1400, 0.08, 'triangle', 0.05);
    }

    function playExplosionSound() {
      const bufferSize = audio.sampleRate * 0.25;
      const noiseBuffer = audio.createBuffer(1, bufferSize, audio.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      const noise = audio.createBufferSource();
      noise.buffer = noiseBuffer;
      const filter = audio.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 1200;
      const gainNode = audio.createGain();
      gainNode.gain.setValueAtTime(0.35, audio.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + 0.45);
      noise.connect(filter).connect(gainNode).connect(audio.destination);
      noise.start();
      noise.stop(audio.currentTime + 0.45);
    }

    function addLog(message) {
      const entry = document.createElement('span');
      entry.textContent = message;
      ui.eventLog.prepend(entry);
      while (ui.eventLog.children.length > 6) {
        ui.eventLog.lastChild.remove();
      }
    }

    function spawnAlien() {
      const radius = THREE.MathUtils.randFloat(16, 32);
      const angle = Math.random() * Math.PI * 2;
      const x = Math.cos(angle) * radius;
      const z = Math.sin(angle) * radius;
      const y = THREE.MathUtils.randFloat(2, 9);
      const geometry = new THREE.SphereGeometry(1.4, alienDetail, alienDetail / 2);
      const material = new THREE.MeshStandardMaterial({
        color: '#ff6ff0',
        emissive: '#ff6ff0',
        emissiveIntensity: 0.7,
        metalness: 0.3,
        roughness: 0.25,
        wireframe: false
      });
      const alien = new THREE.Mesh(geometry, material);
      alien.position.set(x, y, z);
      alien.castShadow = true;
      alien.receiveShadow = true;

      alien.userData.velocity = new THREE.Vector3(-x, -y * 0.25, -z).normalize().multiplyScalar(THREE.MathUtils.randFloat(0.8, 1.5));
      alien.userData.spin = new THREE.Vector3(Math.random(), Math.random(), Math.random()).multiplyScalar(0.6);
      alien.userData.health = 3;
      alien.userData.radius = 1.4;
      scene.add(alien);
      aliens.push(alien);

      addLog(`Alien warp-in detected (poly ${alienDetail})`);
    }

    function spawnParticleBurst(position, color = new THREE.Color('#ff9bff')) {
      const particleCount = 60;
      const geometry = new THREE.BufferGeometry();
      const positions = new Float32Array(particleCount * 3);
      const velocities = new Float32Array(particleCount * 3);
      for (let i = 0; i < particleCount; i++) {
        const dir = new THREE.Vector3().randomDirection().multiplyScalar(Math.random() * 4);
        positions.set([position.x, position.y, position.z], i * 3);
        velocities.set([dir.x, dir.y, dir.z], i * 3);
      }
      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      geometry.setAttribute('velocity', new THREE.BufferAttribute(velocities, 3));
      const material = new THREE.PointsMaterial({ size: 0.15, color, transparent: true, opacity: 0.95 });
      const points = new THREE.Points(geometry, material);
      points.userData.life = 0.7;
      particleBursts.push(points);
      scene.add(points);
    }

    function shoot() {
      if (shootCooldown > 0 || !isStarted) return;
      shootCooldown = 0.18;
      const geometry = new THREE.CapsuleGeometry(0.06, 0.4, 6, 12);
      const material = new THREE.MeshStandardMaterial({
        color: '#7effff',
        emissive: '#7effff',
        emissiveIntensity: 1.6,
        metalness: 0.1,
        roughness: 0.1
      });
      const bullet = new THREE.Mesh(geometry, material);
      bullet.castShadow = true;

      const direction = controls.getDirection(new THREE.Vector3()).normalize();
      const startPosition = controlsObject.position.clone();
      bullet.position.copy(startPosition).add(direction.clone().multiplyScalar(0.8));
      bullet.quaternion.copy(camera.quaternion);
      scene.add(bullet);

      bullets.push({ mesh: bullet, velocity: direction.multiplyScalar(60), life: 1.6 });
      muzzleFlash.position.copy(bullet.position);
      muzzleFlash.intensity = 2.4;
      playShootSound();
    }

    function applyPlayerControls(delta) {
      const speed = 12;
      const boosted = keys.ShiftLeft ? 1.8 : 1;
      playerDirection.set(0, 0, 0);
      if (keys.KeyW) playerDirection.z -= 1;
      if (keys.KeyS) playerDirection.z += 1;
      if (keys.KeyA) playerDirection.x -= 1;
      if (keys.KeyD) playerDirection.x += 1;
      if (keys.Space) playerDirection.y += 0.5;
      if (keys.ControlLeft) playerDirection.y -= 0.5;
      playerDirection.normalize();

      controls.moveRight(playerDirection.x * speed * delta * boosted);
      controls.moveForward(playerDirection.z * speed * delta * boosted);
      controlsObject.position.y += playerDirection.y * speed * delta * boosted;
      controlsObject.position.y = THREE.MathUtils.clamp(controlsObject.position.y, 1, 18);

      player.position.copy(controlsObject.position);
    }

    function updateBullets(delta) {
      for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        bullet.mesh.position.addScaledVector(bullet.velocity, delta);
        bullet.life -= delta;
        bullet.mesh.material.emissiveIntensity = 0.6 + Math.sin(performance.now() * 0.01) * 0.4;
        if (bullet.life <= 0) {
          scene.remove(bullet.mesh);
          bullets.splice(i, 1);
        }
      }
      muzzleFlash.intensity = THREE.MathUtils.lerp(muzzleFlash.intensity, 0, 0.25);
    }

    function updateAliens(delta) {
      for (let i = aliens.length - 1; i >= 0; i--) {
        const alien = aliens[i];
        alien.position.addScaledVector(alien.userData.velocity, delta);
        alien.rotation.x += alien.userData.spin.x * delta;
        alien.rotation.y += alien.userData.spin.y * delta;
        alien.rotation.z += alien.userData.spin.z * delta;

        tmpVec3.copy(alien.position).sub(controlsObject.position);
        const distance = tmpVec3.length();
        if (distance < 2.6) {
          scene.remove(alien);
          aliens.splice(i, 1);
          shields -= 8;
          streak = 0;
          updateStatus();
          addLog('Shields hit by alien impact!');
          playExplosionSound();
          spawnParticleBurst(alien.position, new THREE.Color('#ff5a78'));
          if (shields <= 0) {
            gameOver();
          }
          continue;
        }
      }
    }

    function updateParticles(delta) {
      for (let i = particleBursts.length - 1; i >= 0; i--) {
        const points = particleBursts[i];
        const positions = points.geometry.getAttribute('position');
        const velocities = points.geometry.getAttribute('velocity');
        for (let j = 0; j < positions.count; j++) {
          positions.setX(j, positions.getX(j) + velocities.getX(j) * delta);
          positions.setY(j, positions.getY(j) + velocities.getY(j) * delta);
          positions.setZ(j, positions.getZ(j) + velocities.getZ(j) * delta);
          velocities.setY(j, velocities.getY(j) - delta * 2.5);
        }
        positions.needsUpdate = true;
        velocities.needsUpdate = true;
        points.userData.life -= delta;
        points.material.opacity = Math.max(points.userData.life, 0);
        if (points.userData.life <= 0) {
          scene.remove(points);
          particleBursts.splice(i, 1);
        }
      }
    }

    function handleCollisions() {
      for (let i = aliens.length - 1; i >= 0; i--) {
        const alien = aliens[i];
        for (let j = bullets.length - 1; j >= 0; j--) {
          const bullet = bullets[j];
          const distance = alien.position.distanceTo(bullet.mesh.position);
          if (distance < alien.userData.radius + 0.3) {
            bullets.splice(j, 1);
            scene.remove(bullet.mesh);
            alien.userData.health -= 1;
            spawnParticleBurst(bullet.mesh.position);
            playExplosionSound();
            if (alien.userData.health <= 0) {
              scene.remove(alien);
              aliens.splice(i, 1);
              score += 150;
              streak += 1;
              if (streak % 4 === 0) {
                shields = Math.min(100, shields + 12);
                addLog('Streak bonus! Shields restored.');
              }
              if (aliens.length === 0) {
                wave += 1;
                addLog(`Wave ${wave} incoming!`);
              }
              updateStatus();
            }
            break;
          }
        }
      }
    }

    function updateStatus() {
      ui.score.textContent = `Score ${score}`;
      ui.health.textContent = `Shields ${Math.max(shields, 0)}%`;
      ui.badgeWave.textContent = `Wave ${wave}`;
      ui.badgeStreak.textContent = `Streak ${streak}`;
    }

    function gameOver() {
      addLog('Systems offline. Mission failed.');
      isStarted = false;
      controls.unlock();
      ui.overlay.style.display = 'flex';
      ui.crosshair.style.opacity = 0;
      ui.startButton.textContent = 'Reboot Simulation';
      streak = 0;
      wave = 1;
      shields = 100;
      score = 0;
      aliens.forEach(alien => scene.remove(alien));
      bullets.forEach(bullet => scene.remove(bullet.mesh));
      particleBursts.forEach(p => scene.remove(p));
      aliens.length = 0;
      bullets.length = 0;
      particleBursts.length = 0;
      updateStatus();
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = Math.min(0.05, clock.getDelta());
      nebulaUniforms.time.value += delta;
      stars.rotation.y += delta * 0.02;

      if (isStarted) {
        shootCooldown = Math.max(0, shootCooldown - delta);
        applyPlayerControls(delta);
        updateBullets(delta);
        updateAliens(delta);
        updateParticles(delta);
        handleCollisions();
        spawnTimer += delta;
        if (spawnTimer > nextSpawn) {
          spawnTimer = 0;
          nextSpawn = THREE.MathUtils.randFloat(1.8, Math.max(3.6 - wave * 0.12, 1.2));
          spawnAlien();
        }
      }
      renderer.render(scene, camera);
    }

    const keys = {};
    window.addEventListener('keydown', (event) => {
      keys[event.code] = true;
      if (event.code === 'Space' && !isStarted) {
        event.preventDefault();
      }
      if (event.code === 'KeyR' && !isStarted) {
        ui.overlay.style.display = 'none';
        startGame();
      }
    });
    window.addEventListener('keyup', (event) => keys[event.code] = false);

    ui.startButton.addEventListener('click', () => {
      ui.overlay.style.display = 'none';
      startGame();
    });

    controls.addEventListener('lock', () => {
      ui.crosshair.style.opacity = 1;
    });

    controls.addEventListener('unlock', () => {
      ui.crosshair.style.opacity = 0;
      isStarted = false;
      ui.overlay.style.display = 'flex';
      ui.startButton.textContent = 'Resume Mission';
    });

    function startGame() {
      audio.resume();
      controls.lock();
      isStarted = true;
      spawnTimer = nextSpawn = 0;
      updateStatus();
      addLog('Simulation online.');
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    renderer.domElement.addEventListener('mousedown', (event) => {
      if (event.button === 0) {
        shoot();
      }
    });

    animate();
  </script>
</body>
</html>
